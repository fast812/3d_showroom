<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Viewer</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html, body { margin:0; height:100%; background:#f2f2f2; }
    model-viewer { width:100vw; height:100vh; background:#f2f2f2; }
    .hud{
      position:fixed; left:12px; top:12px; right:12px; z-index:50;
      padding:10px; border-radius:12px; background:rgba(255,255,255,.92);
      font:12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
      word-break:break-all;
    }
    .tip{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:50;
      padding:10px; border-radius:12px; background:rgba(0,0,0,.60); color:#fff;
      font:13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .arbtn{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%, -50%);
      z-index:100;
      width:min(320px, calc(100vw - 48px));
      padding:16px 18px;
      border-radius:16px;
      border:0;
      background:#111;
      color:#fff;
      font:16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 16px 40px rgba(0,0,0,.28);
    }
    .arbtn:active{ transform:translate(-50%, -50%) scale(0.99); }
  </style>
</head>
<body>
  <div class="hud" id="hud">로딩 중…</div>

  <model-viewer id="mv"
    camera-controls
    autoplay
    ar
    ar-scale="auto"
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    shadow-intensity="0.3">

    <!-- ✅ 중앙 큰 AR 버튼(항상 보이게) -->
    <button class="arbtn" slot="ar-button">AR로 크게 보기</button>
  </model-viewer>

  <div class="tip">
    iPhone: 버튼을 누르면 Quick Look(AR)이 열립니다. <br/>
    Android: 바닥을 비춘 뒤 화면을 탭해서 배치하세요.
  </div>

  <script>
    const mv = document.getElementById('mv');
    const hud = document.getElementById('hud');

    const p = new URLSearchParams(location.search);
    const glb = p.get('m') || 'models/deer.glb';
    const usdz = p.get('usdz') || '';  // iPhone용

    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    // ✅ 핵심: iOS는 GLB 로드를 아예 피하고, USDZ(ios-src)만 사용
    if (isIOS) {
      if (!usdz) {
        hud.textContent = '❌ iPhone에서는 usdz 파라미터가 필요합니다.';
      } else {
        mv.removeAttribute('src');              // GLB 로딩 방지
        mv.setAttribute('ios-src', usdz);       // Quick Look용
        hud.textContent = `iPhone 모드 ✅ ios-src=${usdz}`;
      }
    } else {
      // Android/PC: GLB 로드
      mv.setAttribute('src', glb);
      if (usdz) mv.setAttribute('ios-src', usdz); // 있어도 무해
      hud.textContent = `Android/PC 모드 ✅ src=${glb}`;
    }

    mv.addEventListener('error', (e) => {
      console.error(e);
      hud.textContent = '❌ model-viewer error (콘솔 확인)';
    });

    mv.addEventListener('ar-status', (e) => {
      hud.textContent += ` | AR status=${e.detail.status}`;
    });
  </script>
</body>
</html>